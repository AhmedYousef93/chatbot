<?php

namespace App\Services;

use App\Models\ChatHistory;
use App\Models\HousingUnit;
use App\Repositories\HousingUnitRepository;
use Illuminate\Support\Facades\Http;

class ChatService
{
    public function __construct(protected HousingUnitRepository $housingUnitRepo) {}

    public function greetings(string $userMessage): bool
    {
        $greetings = ['Ù‡Ù„Ø§',
                      'Ø£Ù‡Ù„Ø§Ù‹', 'Ù…Ø±Ø­Ø¨Ø§Ù‹', 'Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…', 'ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±', 'Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±', 'ÙƒÙŠÙ Ø­Ø§Ù„ÙƒØŸ',
                      'Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹', 'ØµØ¨Ø§Ø­ Ø§Ù„Ù†ÙˆØ±', 'Ù…Ø³Ø§Ø¡ Ø§Ù„Ù†ÙˆØ±', 'Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ', 'ØªØ­ÙŠØ© Ø·ÙŠØ¨Ø©', 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ',
                      'ÙƒÙŠÙ Ø­Ø§Ù„ÙƒÙ…ØŸ', 'Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡', 'ØµØ¨Ø§Ø­ Ø§Ù„ÙˆØ±Ø¯', 'Ù…Ø³Ø§Ø¡ Ø§Ù„ÙˆØ±Ø¯', 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ø§Ù„ØµØ¯ÙŠÙ‚',
                      'Hello', 'Hi', 'Hey', 'Good morning', 'Good afternoon', 'Good evening', 'How are you?', 'Howdy',
                      'Greetings', "What's up?", 'Welcome', 'Morning', 'Afternoon', 'Evening', 'Hi there', 'Yo', "How's it going?",
                      "What's going on?", 'Good day', 'Salutations'
        ];
        foreach ($greetings as $greeting) {
            if (stripos($userMessage, $greeting) !== false) {
                return true;
            }
        }
        return false;
    }

    public function cityFound(string $userMessage): bool
    {
        $cities = [
            'Ø§Ù„Ø±ÙŠØ§Ø¶', 'Ø¬Ø¯Ø©', 'Ù…ÙƒØ©', 'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©', 'Ø§Ù„Ø¯Ù…Ø§Ù…', 'Ø§Ù„Ø®Ø¨Ø±', 'Ø§Ù„Ø·Ø§Ø¦Ù',
            'Ø§Ù„Ø¸Ù‡Ø±Ø§Ù†', 'Ø­Ø§Ø¦Ù„', 'ØªØ¨ÙˆÙƒ', 'Ø£Ø¨Ù‡Ø§', 'Ù†Ø¬Ø±Ø§Ù†', 'Ø¬Ø§Ø²Ø§Ù†', 'Ø§Ù„Ø¨Ø§Ø­Ø©',
            'Ø¨ÙŠØ´Ø©', 'Ø§Ù„Ø®Ø±Ø¬', 'ÙŠÙ†Ø¨Ø¹', 'Ø¹Ù†ÙŠØ²Ø©', 'Ø¨Ø±ÙŠØ¯Ø©', 'Ø§Ù„Ù‚Ø·ÙŠÙ', 'Ø±Ø§Ø¨Øº',
            'Ø¹Ø±Ø¹Ø±', 'Ø§Ù„Ø±Ø³', 'Ø³ÙƒØ§ÙƒØ§', 'Ø§Ù„Ù‚Ù†ÙØ°Ø©', 'Ù…Ø­Ø§ÙŠÙ„', 'Ø®Ù…ÙŠØ³ Ù…Ø´ÙŠØ·', 'Ø§Ù„Ø¬Ø¨ÙŠÙ„'
        ];

        $cityFound = false;
        foreach ($cities as $city) {
            if (stripos($userMessage, $city) !== false) {
                return true;
            }
        }
        return false;
    }


    public function callAiWithMemory(string $userMessage): array|string
    {
        $previousMessages[] = ['role' => 'user', 'content' => $userMessage];
        $moreUnitsRequested = $this->isMoreUnitsRequested($userMessage);
        if ($moreUnitsRequested) {
            return $this->housingUnitRepo->callHistoryData();
        }
        $limit      = $moreUnitsRequested ? 5 : 2;
        $aiMessages = [
            [
                'role'    => 'system',
                'content' => <<<EOD
Ø£Ù†Øª Ø±ÙˆØ¨ÙˆØª Ø¯Ø±Ø¯Ø´Ø© Ø¹Ù‚Ø§Ø±ÙŠ Ù…Ø­ØªØ±Ù. Ø¯ÙˆØ±Ùƒ ØªØ³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ„Ø§Ù‚ÙŠ Ø´Ù‚Ù‚ Ø£Ùˆ ÙˆØ­Ø¯Ø§Øª Ø³ÙƒÙ†ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙƒÙ„Ø§Ù…Ù‡.

Ø¹Ù†Ø¯Ùƒ Ø°Ø§ÙƒØ±Ø© Ù…Ø­Ø§Ø¯Ø«Ø©ØŒ ÙŠØ¹Ù†ÙŠ ØªÙ‚Ø¯Ø± ØªÙØªÙƒØ± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ù„ÙŠ Ù‚Ø¨Ù„ÙƒØŒ Ù„ÙƒÙ† Ù„Ø§Ø²Ù… ØªØªØ¨Ø¹ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø¯ÙŠ Ø¨Ø¯Ù‚Ø© ÙƒØ£Ù†Ùƒ Ø·ÙÙ„ ØµØºÙŠØ±:

---

ğŸ“Œ Ø£ÙˆÙ„Ø§Ù‹: â—â— Ù…Ù…Ù†ÙˆØ¹ ØªÙ…Ø§Ù…Ù‹Ø§ ØªØ³ØªÙ†ØªØ¬ Ø£Ùˆ ØªØ®Ù…Ù‘Ù† Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø© Ù…Ø´ Ù…Ø°ÙƒÙˆØ±Ø© ÙÙŠ ÙƒÙ„Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙˆØ¶ÙˆØ­.

âŒ Ù…Ù…Ù†ÙˆØ¹ ØªØ¶ÙŠÙ Ø§Ù„Ø³Ø¹Ø± Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø§ Ù‚Ø§Ù„Ø´ Ø¹Ù„ÙŠÙ‡.
âŒ Ù…Ù…Ù†ÙˆØ¹ ØªØ¶ÙŠÙ Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù Ù„Ùˆ Ù…Ø§ Ù‚Ø§Ù„Ø´.
âŒ Ù…Ù…Ù†ÙˆØ¹ ØªÙ‚ÙˆÙ„ ÙÙŠÙ‡ "ÙˆØ§ÙŠ ÙØ§ÙŠ" Ø£Ùˆ "Ù…Ø·Ø¨Ø®" Ø£Ùˆ Ø£ÙŠ Ù…ÙŠØ²Ø© Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø§ ÙƒØªØ¨Ø´ ÙƒØ¯Ù‡ Ø¨Ù†ÙØ³Ù‡.
âŒ Ù…Ù…Ù†ÙˆØ¹ ØªØµØ­Ø­ Ø£Ùˆ ØªØºÙŠÙ‘Ø± ÙƒÙ„Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø­ØªÙ‰ Ù„Ùˆ ÙÙŠÙ‡ Ø£Ø®Ø·Ø§Ø¡ Ø¥Ù…Ù„Ø§Ø¦ÙŠØ©.

âœ… ÙÙ‚Ø· Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØµØ±ÙŠØ­Ø© Ù…Ø«Ù„:
- Ù…Ø¯ÙŠÙ†Ø© (Ø²ÙŠ: Ø§Ù„Ø±ÙŠØ§Ø¶)
- Ø³Ø¹Ø± (Ø²ÙŠ: 3000 Ø±ÙŠØ§Ù„)
- ØºØ±Ù (Ø²ÙŠ: ØºØ±ÙØªÙŠÙ†)
- Ù…Ù…ÙŠØ²Ø§Øª (Ø²ÙŠ: Ù…ÙØ±ÙˆØ´Ø©ØŒ ÙÙŠÙ‡Ø§ Ù…Ø³Ø¨Ø­ØŒ ÙˆØ§ÙŠ ÙØ§ÙŠ)

ÙˆÙ‚ØªÙ‡Ø§ Ø§Ø³ØªØ®Ø±Ø¬Ù‡Ø§ØŒ ÙˆØ§ÙƒØªØ¨Ù‡Ø§ Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­ Ø¯Ø§Ø®Ù„:
`[QUERY: ...]`

ğŸ“Œ Ø«Ø§Ù†ÙŠÙ‹Ø§: Ø§Ù„Ø³Ø¹Ø± Ø¨ÙŠØªÙÙ‡Ù… ÙƒØ¯Ù‡ Ø¨Ø§Ù„Ø¸Ø¨Ø·:

ğŸŸ¢ Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒØªØ¨ Ø§Ù„Ø³Ø¹Ø± Ù…Ù† ØºÙŠØ± Ø£ÙŠ ÙƒÙ„Ù…Ø© Ø²ÙŠ (Ø£Ù‚Ù„ - Ø£ÙƒØªØ± - Ù…Ø§ Ø¨ÙŠÙ†)ØŒ Ø§Ø¹ØªØ¨Ø±Ù‡ "Ø­Ø¯ Ø£Ù‚ØµÙ‰" ÙŠØ¹Ù†ÙŠ (Ø£Ù‚Ù„ Ù…Ù† Ø£Ùˆ ÙŠØ³Ø§ÙˆÙŠ).

ğŸ‘¦ Ù…Ø«Ø§Ù„:
> "Ø´Ù‚Ø© ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ Ø¨Ù€ 3500 Ø±ÙŠØ§Ù„"

âœ… ØªØ±Ø¬Ù…Ù‡Ø§ Ø¥Ù„Ù‰:
`[QUERY: location=Ø§Ù„Ø±ÙŠØ§Ø¶, price=<=3500]`

ğŸŸ¡ Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒØªØ¨ ØµØ±Ø§Ø­Ø©:
> "Ø£Ù‚Ù„ Ù…Ù† 4000" â†’ price=<=4000
> "Ø£ÙƒØªØ± Ù…Ù† 5000" â†’ price=>=5000
> "Ù…Ø§ Ø¨ÙŠÙ† 3000 Ùˆ 6000" â†’ ØªØ¬Ø§Ù‡Ù„ Ø¯Ù„ÙˆÙ‚ØªÙŠ Ø£Ùˆ Ù‚ÙˆÙ„ Ù„Ù‡ "Ø­Ø¯Ø¯ Ø³Ø¹Ø± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ù„Ùˆ Ø³Ù…Ø­Øª"

---

ğŸ“Œ Ø«Ø§Ù„Ø«Ù‹Ø§: Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø§ ÙƒØªØ¨Ø´ Ø§Ù„Ø³Ø¹Ø± Ø£Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ùˆ Ø§Ù„ØºØ±Ù ÙÙŠ Ø±Ø³Ø§Ù„ØªÙ‡ Ø§Ù„Ø£Ø®ÙŠØ±Ø©ØŒ ØªÙ‚Ø¯Ø± ØªØ¨Øµ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙˆØªØ´ÙˆÙ Ù„Ùˆ ÙƒØ§Ù† Ù‚Ø§Ù„Ù‡Ù… Ù‚Ø¨Ù„ ÙƒØ¯Ù‡.

ğŸ“Œ Ø±Ø§Ø¨Ø¹Ù‹Ø§: Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ù„ Ù…Ø¯ÙŠÙ†Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©ØŒ Ø§Ù†Ø³Ù Ø£ÙŠ Ù…Ø¯Ù† Ù‚Ø§Ù„Ù‡Ø§ Ù‚Ø¨Ù„ ÙƒØ¯Ù‡.

---

ğŸ“Œ Ø®Ø§Ù…Ø³Ù‹Ø§: Ù„Ùˆ ÙƒÙ„Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´ ÙˆØ§Ø¶Ø­ Ø£Ùˆ Ù†Ø§Ù‚ØµØŒ Ù‚Ù„ Ù„Ù‡:

"Ù„Ù… Ø£ÙÙ‡Ù… Ø·Ù„Ø¨ÙƒØŒ Ù‡Ù„ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙˆØ¶ÙŠØ­Ù‡ Ø£ÙƒØ«Ø±ØŸ Ù…Ø«Ù„: Ø´Ù‚Ø© ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ Ø¨Ø³Ø¹Ø± Ø£Ù‚Ù„ Ù…Ù† 5000."

---

ğŸ“Œ Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¯Ø§ÙŠÙ…Ù‹Ø§ ÙŠÙƒÙˆÙ† ÙƒØ¯Ù‡:

`[QUERY: location=..., price=..., room=..., feature=[...]]`

Ù„Ùˆ Ù…ÙÙŠØ´ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªØŒ ØªØ¬Ø§Ù‡Ù„Ù‡Ø§ Ø£Ùˆ Ø³ÙŠØ¨ Ù…ÙƒØ§Ù†Ù‡Ø§ ÙØ§Ø¶ÙŠ.

---

ğŸ¯ Ù‡Ø¯ÙÙƒ Ø§Ù„ÙˆØ­ÙŠØ¯ Ù‡Ùˆ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„ÙŠ Ù‚Ø§Ù„Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙˆØ¶ÙˆØ­ØŒ ÙˆØªÙƒØªØ¨Ù‡Ø§ ÙÙŠ `[QUERY: ...]` Ø¨Ø³ØŒ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ÙƒÙ„Ø§Ù… Ø²ÙŠØ§Ø¯Ø©.

EOD

            ],
        ];

        $aiMessages = array_merge($aiMessages, $previousMessages);

        $response = Http::withToken('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')->post('https://openrouter.ai/api/v1/chat/completions', [
            'model'    => 'mistralai/mistral-7b-instruct',
            'messages' => $aiMessages,
        ]);

        $botResponse = $response['choices'][0]['message']['content'] ?? '';


        if (preg_match('/\[QUERY: (.+?)\]/', $botResponse, $queryMatch)) {
            $queryString = $queryMatch[1];

            $queryString = preg_replace_callback('/feature=\[(.*?)\]/', function ($matches) {
                $clean = str_replace(["'", '"'], '', $matches[1]);
                return "feature={$clean}";
            }, $queryString);

            parse_str(str_replace([', ', ','], '&', $queryString), $queryArray);

            $this->housingUnitRepo->createChatHistory($queryArray, $limit);

            return $this->housingUnitRepo->getPropertiesByFilters($queryString, $limit);
        }

        return [];
    }


    public function isMoreUnitsRequested(string $userMessage): bool
    {
        $moreUnitsKeywords = ['Ø£ÙƒØªØ±', 'Ø²ÙŠØ§Ø¯Ø©', 'Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø§Øª', 'Ø£ÙÙƒØ§Ø± Ø¥Ø¶Ø§ÙÙŠØ©', 'Ù…Ø²ÙŠØ¯', 'Ø¹Ø¯Ø¯ Ø£ÙƒØ¨Ø±', 'Ø£Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯', 'Ø´Ù‚Ù‚ Ø£ÙƒØ«Ø±', 'ÙƒÙ…Ø§Ù†'];

        foreach ($moreUnitsKeywords as $keyword) {
            if (stripos($userMessage, $keyword) !== false) {
                return true;
            }
        }

        return false;
    }


}
